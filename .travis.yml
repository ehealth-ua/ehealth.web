language: node_js
services:
- docker
node_js:
- 8.10.0
cache:
  directories:
  - "$HOME/.npm"
env:
  global:
  - TRUNK_BRANCH="master"
  - DOCKER_HUB_ACCOUNT="edenlabllc"
  - CHART="fe"
  - secure: gm0iZ/G3CE5DQdZUuVeEofhNMkw4EaRdn+kJGCcBilY/9v7Rzs/hb/Wle0kCEPEHxkWhGg75hFZGiDtn+a1YhMoD2rax7RTb2nSuVEs/2gLhyTFWgeeZcxBrx7E5gh+H5AU8yVJdiM/j2WAXpqzjOn+ZRHd3fXx5Bv654VaVHCoHM3Ok4RUG0fK2dXRXK6g7Ct9HEtlCLcwpPVgpuhpeWeAE6DwM2hw63XLkXQZAfO0rlCTBZN4OCe/Dtx3Hb2hhsiDoOul5uCK06PexgqY7uA64MN5eqe5nP9LbjULlCvTQFrgw+eTdhnHT7HpVWKj9mCjVl/kdFRwLM212cA8XnNxkQ8jh1OnoRYpYYpFaaaZ3i5HrqDujg46eguetWK4C0m7KpBxkYDI8b8BL3jNxlzdwYFmDzfMBkeBKi/VimX9KTAOzR1VF/mvEAnzdxQhgDgPJfbpkj+mqqTrYFoP2h9eCNzbym+La3GDfrjNXzSjruaA/6xVMNqkc26jB1F0TtQX8dZcol35T6d2DS+tFMZTenEgN5EUCYGfOW9e0Kgo7yDzM6hYc5Q644qbh9Rqh5x7/4TJ/kh2/pUsNcbEIrCxBLj7jaxw7gBKEUoNDi7dCg1KipJcEEfOmkDkB6gt4yVyY0jXUNNQW1p5ZXoq7aUaNzOMmqxycZjE7WqJSWKc=
  - secure: WXKeSZzt+LmDyN37pMm7tXNZybrwrdbTxzbj2ol7Elf6uqVO6oeq4MpW9louD20tdWpT8am76YX5Mgq4iQ0PKO0vsPzK5Nis7Pi/zfEJKofIASFnSgogzgAd6NE/1Qsl1/mOFl6W4pgNJS/x2vxF/azrhMx8KtRrZh91jCOLjSEaQOgsOfLbelc/LoQpYU/moaq8O7KKE1HCnjSNohX99YXwC6xl9WnreAPCJ70dL5P5TqRj7T5ZzJd5/MOW4BPlcuMtuRzP31UIaomDJqrCx3LhDWbmdjY0tvLtFAovhpaojCSxJPW0J3Y5WqizoFE3Ep0FqtwgpJdCkmf4gAkUtbYf5jPt6a/isnOHcerNkvj5Q8q2qTp1g30A90GHZ5FNXiERYAYwHIH6zZ1Jmj7Pdn36DGcmVI+WkVASrQ20s6W67pzpi1pcr2jurTsfU0HakPAzXLS3nVpOOgrPw60ekog14dbkaid16fGjAbSBA+z4b4D2T31tdNMjBHmIIKYdyMPu/dMfTPV/KU5BOKbkNwbY/T2i/KxsRrFjkAV2fkJW4cq3sMEgvhJCnc1e65fzxPujq4fiHhutliUfOgke82JcuZiKiwdwIjZPCV0NIFwA5vJKZH2cQ5HnP6Ed0WUX013b2s9tXGA+Ni77xCU84eilURNSqNxdK+txHSYq818=
  - secure: glG8SKqgaBCyuSHSoRXPv9U7V8L0r/BdDIdYh7quWAtPDAEJT/qrhPrr2nr8evIADFseKobx7vBef4J3D+l1orGzTV7yVDr41qElbGWIyMrwMRHCChYqgdvEfgk3MCmTWpRU61dl1rxaX1YTOOdLLe/FXc+FX2Pw3wy3DBFbHLiAFkVt1tUQXU5UCsgoFM9J9w5+Mq/WxGsEMac8lvUTblno/u6tTzJnOhXH/k7uGkrfhpmcASZTIiNDbAMGxPrBdIrOtxewf5PUfQ2TONonhSCxDV4QEue517TSIbOHynHtC/MAMV/nmcs884cbVvRx8PhiAvE3CSZLeR7L1XIoVreOR94lDYbzIL/qjZ86FbuiYJdBoznHGchZVdDwrAbtkcHbTo2/NRFTKlhLZOacyuAXr+A0l+w1/Ywf3YIiZcWFsFlQLU0A2dwhjXnlwmojyBOu2oN/pvyZrCTx3hr75+hd5WPb7ShC+yFQoxcxJFKwxM+kuXDKUZvcPB54+DAo6YBd6tovAEWChLpnKGiRBjH3uyzRG6i9YFZ6kQcUWf4uYZmOYF7PMhzafv1yeNaqvReaQ+xB5NdnMalD6oL99FVgqSToccIfoC0P53AI3LjKb7eCkDCB/a9IPg3gIba7rSP9cSecC4eStJqM+aCDzO+nwxrn+U3jux0YuK8gPWk=
before_install:
- npm install cipm --global --quiet
install:
- cipm --ignore-scripts
- npm install puppeteer
- npx lerna bootstrap --npm-client=cipm
script: npm test
before_deploy:
- git config --global user.email "deploy@travis-ci.org" &&
  git config --global user.name "Deployment Bot" &&
  git config --global credential.helper "store"
- echo "https://${GITHUB_TOKEN}:@github.com" > $HOME/.git-credentials
- git checkout $TRAVIS_BRANCH
- echo $DOCKER_PASSWORD | docker login --username $DOCKER_USERNAME --password-stdin
- openssl aes-256-cbc -K $encrypted_d422cd97315f_key -iv $encrypted_d422cd97315f_iv -in eHealth-d14f79f426fb.json.enc -out eHealth-d14f79f426fb.json -d
- gcloud auth activate-service-account --key-file=$TRAVIS_BUILD_DIR/eHealth-d14f79f426fb.json &&
  gcloud container clusters get-credentials dev --zone europe-west1-d --project ehealth-162117
- curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get | bash
- git clone https://github.com/edenlabllc/ehealth.charts.git charts
deploy:
  provider: script
  script: 'npm run publish -- --yes -m "chore(release): publish %s [skip ci]"'
  skip_cleanup: true
  on:
    condition: "$TRAVIS_BRANCH =~ (^$TRUNK_BRANCH|[[:digit:]]-stable)$"
after_deploy: npm run update-chart && npm run deploy-chart
